<script setup lang="ts">
import type { TExtension } from '@/types'

import { useThemeStore, useThemeStoreState } from '@/stores/useThemeStore'

import LucideSun from '~icons/lucide/sun'
import LucideMoonStar from '~icons/lucide/moon-star'
import LucideShare2 from '~icons/lucide/share-2'
import LucidePackagePlus from '~icons/lucide/package-plus'
import LucideExternalLink from '~icons/lucide/external-link'
import LucideTrash2 from '~icons/lucide/trash-2'
import { useRemoteExtensions } from '@/composables/useRemoteExtensions'
import { $d } from '@/utils/dayjs'
import { toast } from 'vue-sonner'
import { groupBy } from '@/utils/groupBy'

const { isDark } = useThemeStoreState()
const { toggleTheme } = useThemeStore()

const searchQuery = ref('')

const localExtensions = ref<TExtension[]>([])
const { remoteExtensions, importRemoteExtensions, deleteRemoteExtensions } = useRemoteExtensions()

const groupedLocalExtensions = computed(() => {
  return groupBy(
    localExtensions.value.map((e) => {
      return {
        ...e,
        colors: remoteExtensions.value
          .filter((x) => x.extensions.some((v) => v.id === e.id))
          .map((v) => v.color),
      }
    }),
    (e) => (e.enabled ? 'Enabled' : 'Disabled'),
  )
})

const onToggleEnabled = async (extension: TExtension) => {
  chrome.management.get(extension.id, (extension) => {
    if (chrome.runtime.lastError) {
      toast.error('Failed to get extension info')
      return
    }
    const newEnabledState = !extension.enabled
    chrome.management.setEnabled(extension.id, newEnabledState, () => {
      if (chrome.runtime.lastError) {
        toast.error('Failed to toggle extension')
        return
      }
      localExtensions.value = localExtensions.value.map((e) =>
        e.id === extension.id ? { ...e, enabled: newEnabledState } : e,
      )
    })
  })
}

const onUninstallExtension = async (extension: TExtension) => {
  chrome.management.uninstall(extension.id, {}, () => {
    if (chrome.runtime.lastError) {
      toast.error('Failed to remove extension')
      return
    }
  })
}

const onInstallExtension = async (extension: TExtension) => {
  chrome.tabs.create({
    url: extension.homepageUrl || `https://chromewebstore.google.com/detail/${extension.id}`,
  })
}

const toBase64 = (url: string): Promise<string | undefined> => {
  return new Promise((resolve) => {
    const img = new Image()
    img.crossOrigin = 'Anonymous'
    img.onload = () => {
      const canvas = document.createElement('canvas')
      canvas.width = img.width
      canvas.height = img.height
      const ctx = canvas.getContext('2d')
      if (!ctx) {
        resolve(undefined)
        return
      }
      ctx.drawImage(img, 0, 0)
      try {
        const dataURL = canvas.toDataURL('image/png')
        resolve(dataURL)
      } catch {
        resolve(undefined)
      }
    }
    img.onerror = () => {
      resolve(undefined)
    }
    img.src = url
  })
}

const onOpenExtensions = () => {
  chrome.tabs.create({
    url: 'chrome://extensions/',
  })
}

const exportExtensions = async () => {
  try {
    const data = {
      exportedAt: Date.now(),
      extensions: await Promise.all(
        localExtensions.value.map(async (v) => {
          return {
            ...v,
            icon: v.icons?.length ? await toBase64(v.icons[v.icons.length - 1].url) : undefined,
          }
        }),
      ),
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], {
      type: 'application/json',
    })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = window.prompt('Enter a name for the export') || `Extensions-${Date.now()}.json`
    a.click()
    URL.revokeObjectURL(url)
    toast.success('Extensions exported successfully!')
  } catch (error) {
    toast.error(
      `${error instanceof Error ? `Error: ${error.message}` : 'Failed to export extensions!'}`,
    )
  }
}

const remoteKey = 'remoteExtensions'

const onImportExtensions = (event: Event) => {
  const target = event.target as HTMLInputElement
  if (!target) return
  importRemoteExtensions(target.files?.[0])
  target.value = ''
}

onMounted(() => {
  chrome.management.getAll((extensions) => {
    localExtensions.value = extensions as TExtension[]
  })
  chrome.storage.local.get([remoteKey], (result) => {
    if (result[remoteKey]) {
      try {
        const data = JSON.parse(result[remoteKey])
        if (Array.isArray(data)) remoteExtensions.value = data
      } catch (error) {
        console.error('Error parsing remote extensions', error)
      }
    }
  })
})
</script>

<template>
  <div class="bg-gray-50 flex-1 flex flex-col dark:bg-neutral-900 overflow-hidden">
    <!-- Header -->
    <div class="px-4 flex justify-between items-center dark:bg-neutral-900 pt-4 flex-none">
      <h1 class="text-base font-semibold">Extensions</h1>

      <!-- Action Buttons -->
      <div class="flex">
        <IconButton @click="onOpenExtensions" tooltip="Manage Extensions">
          <LucideExternalLink class="w-4 h-4" />
        </IconButton>
        <IconButton tooltip="Export" @click="exportExtensions">
          <LucideShare2 class="w-4 h-4" />
        </IconButton>
        <IconButton as="label" tooltip="Import">
          <LucidePackagePlus class="w-[18px] h-[18px]" />
          <input type="file" accept=".json" @change="onImportExtensions" class="hidden" />
        </IconButton>
        <IconButton tooltip="Toggle Theme" @click="toggleTheme">
          <LucideSun class="w-[18px] h-[18px]" v-if="isDark" />
          <LucideMoonStar class="w-4 h-4" v-else />
        </IconButton>
      </div>
    </div>

    <!-- Status Messages -->
    <!-- <div class="px-4 flex-none mt-2">
      <div
        v-if="status"
        :class="[
          'p-3 rounded-lg mb-4 text-sm',
          status.type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : '',
          status.type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' : '',
          status.type === 'info' ? 'bg-blue-100 text-blue-800 border border-blue-200' : '',
        ]"
      >
        {{ status.message }}
      </div>
    </div> -->

    <!-- Search -->
    <div class="px-4 mt-2 flex-none">
      <input
        v-model="searchQuery"
        type="text"
        placeholder="Search extensions..."
        class="w-full p-3 border border-gray-300 dark:border-neutral-800 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      />
    </div>

    <div class="overflow-y-auto flex flex-col gap-4 px-4 flex-1 pb-8">
      <!-- Enabled Extensions -->
      <div v-if="groupedLocalExtensions['Enabled']?.length">
        <div class="text-sm font-semibold">Enabled</div>
        <div class="flex flex-wrap gap-2 mt-2">
          <ExtensionCard
            v-for="extension in groupedLocalExtensions['Enabled']"
            :key="extension.id"
            :is-local="true"
            :extension="extension"
            @toggle="onToggleEnabled"
            @install="onInstallExtension"
            @uninstall="onUninstallExtension"
          />
        </div>
      </div>

      <!-- Disabled Extensions -->
      <div v-if="groupedLocalExtensions['Disabled']?.length">
        <div class="text-sm font-semibold">Disabled</div>
        <div class="flex flex-wrap gap-2 mt-2">
          <ExtensionCard
            v-for="extension in groupedLocalExtensions['Disabled']"
            :key="extension.id"
            :is-local="true"
            :extension="extension"
            @toggle="onToggleEnabled"
            @install="onInstallExtension"
            @uninstall="onUninstallExtension"
          />
        </div>
      </div>

      <div v-for="(item, index) in remoteExtensions" :key="index">
        <div class="flex justify-between gap-2">
          <div
            class="w-2 h-2 flex-none self-center rounded-full"
            :style="{ backgroundColor: item.color }"
          />
          <div class="flex-1 overflow-hidden flex flex-col">
            <div class="text-sm font-semibold truncate">
              {{ item.file.name }}
            </div>
            <div class="text-xs text-muted-foreground">
              {{ $d(item.importedAt).fromNow() }}, {{ item.extensions.length }} extensions
            </div>
          </div>
          <div class="flex-none">
            <IconButton tooltip="Delete" @click="deleteRemoteExtensions(item)">
              <LucideTrash2 class="w-4 h-4" />
            </IconButton>
          </div>
        </div>
        <div class="flex flex-wrap gap-2 mt-2">
          <ExtensionCard
            v-for="extension in item.extensions.filter(
              (e) => !localExtensions.some((v) => v.id === e.id),
            )"
            :key="extension.id"
            :extension="extension"
            @toggle="onToggleEnabled"
            @install="onInstallExtension"
            @uninstall="onUninstallExtension"
          />
        </div>
      </div>

      <!-- Empty State -->
      <!-- <div v-if="filteredExtensions.length === 0" class="text-center py-8 text-gray-500">
        <div class="text-sm font-medium text-gray-900 mb-2">No extensions in your list</div>
        <p class="text-xs">Import a JSON file to get started, or add extensions manually</p>
      </div> -->
    </div>
  </div>
</template>
